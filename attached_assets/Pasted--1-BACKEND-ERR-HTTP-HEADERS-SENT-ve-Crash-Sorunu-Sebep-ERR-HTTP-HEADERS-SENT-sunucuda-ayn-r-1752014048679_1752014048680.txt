âœ… 1. BACKEND: ERR_HTTP_HEADERS_SENT ve Crash Sorunu
ğŸ” Sebep:
ERR_HTTP_HEADERS_SENT, sunucuda aynÄ± response objesi Ã¼zerinden birden fazla res.send() veya res.json() veya res.redirect() Ã§aÄŸrÄ±sÄ± yapÄ±ldÄ±ÄŸÄ±nda ortaya Ã§Ä±kar.

âœ… Ã‡Ã¶zÃ¼m:
API routeâ€™unu gÃ¶zden geÃ§ir:

ts
Kopyala
DÃ¼zenle
app.post('/api/analyze', async (req, res) => {
  try {
    const result = await callYceApi(req.body);
    return res.json({ success: true, result });
  } catch (err) {
    console.error('ERROR:', err);
    if (!res.headersSent) {
      return res.status(500).json({ success: false, message: err.message });
    }
  }
});
Dikkat: if (!res.headersSent) kontrolÃ¼ yoksa sunucu yeniden res gÃ¶ndermeye Ã§alÄ±ÅŸÄ±p Ã§Ã¶ker. Ã–zellikle await iÅŸleminden sonra hem res.send hem next(err) gibi ikinci bir call varsa bu hata oluÅŸur.

âœ… 2. FRONTEND: Modal Render Sorunu (FaceAnalysisCamera gÃ¶rÃ¼nmÃ¼yor)
ğŸ” OlasÄ± Nedenler:
showFacePage = true ama modal component DOMâ€™a hiÃ§ mount edilmiyor (ÅŸartlÄ± render yanlÄ±ÅŸ yerde).

React portal problemi (Ã¶rn. ReactDOM.createPortal() ile farklÄ± DOM aÄŸacÄ±na render edip gÃ¶rÃ¼nmemesi).

CSS display: none, opacity: 0, z-index: -1 gibi gÃ¶rÃ¼nmezlik hatalarÄ±.

SDK yÃ¼klenmeden window.YCE.init() Ã§aÄŸrÄ±lÄ±yor â†’ widget DOMâ€™a yerleÅŸemiyor.

âœ… Kontrol ve Ã‡Ã¶zÃ¼m SÄ±rasÄ±:
A. Component Conditional Rendering:
tsx
Kopyala
DÃ¼zenle
{showFacePage && <FaceAnalysisCamera />}
Bu satÄ±rdan Ã¶nce console.log("rendering camera") koy ve terminalde gÃ¶rÃ¼nÃ¼p gÃ¶rÃ¼nmediÄŸini kontrol et.

EÄŸer gÃ¶rÃ¼nÃ¼yorsa, FaceAnalysisCamera component'i DOMâ€™a giriyor demektir. Aksi durumda showFacePage false veya Ã¼st bileÅŸen mount olmuyor.

B. React Portals:
EÄŸer FaceAnalysisCamera <Modal> iÃ§inde ReactDOM.createPortal ile render ediliyorsa, hedef DOM Ã¶ÄŸesinin gerÃ§ekten DOMâ€™da var olduÄŸundan emin ol. document.getElementById('modal-root') gibi hedef, uygulama yÃ¼klenmeden Ã¶nce tanÄ±mlÄ± deÄŸilse render baÅŸarÄ±sÄ±z olur.

null dÃ¶nÃ¼yorsa, ReactDOM.createPortal da render etmez.

C. CSS GÃ¶rÃ¼nmezlik:
Dev tools ile <FaceAnalysisCamera /> DOM Ã¶ÄŸesinin:

GÃ¶rÃ¼nÃ¼p gÃ¶rÃ¼nmediÄŸini (display, opacity, z-index)

position: fixed/absolute olup gÃ¶rÃ¼nmeyen bir yerde mi render olduÄŸunu

BaÅŸka bir Ã¶ÄŸenin arkasÄ±nda mÄ± kaldÄ±ÄŸÄ±nÄ± kontrol et.

D. SDK & Ref:
SDK script yÃ¼klendikten sonra mÄ± YCE.init() Ã§aÄŸrÄ±lÄ±yor?

ref.current null ise, container: ref.current baÅŸarÄ±sÄ±z olur, SDK UI hiÃ§bir yere baÄŸlanamaz.

DoÄŸru kullanÄ±m:

tsx
Kopyala
DÃ¼zenle
useEffect(() => {
  if (!window.YCE || !faceRef.current) return;
  window.YCE.init({ container: faceRef.current, ... });
}, [showFacePage]); // veya [faceRef.current]
âœ… 3. CHAT WIDGET ENTEGRASYON SORUNU
ğŸ” OlasÄ± Nedenler:
Chat widget <iframe> gibi izole DOM iÃ§indeyse, Perfect SDK window contextâ€™ini doÄŸru bulamaz.

SDK container Ã¶ÄŸesini sabit DOM beklerken, React'ta ref henÃ¼z oluÅŸmamÄ±ÅŸ olabilir.

SPA iÃ§inde widget component tekrar mount edilirse, Ã¶nceki YCE.init() Ã§aÄŸrÄ±sÄ± SDKâ€™yÄ± bozar.

âœ… Ã‡Ã¶zÃ¼m Ã–nerileri:
A. SDK Script'i Dinamik ve KontrollÃ¼ YÃ¼kle
tsx
Kopyala
DÃ¼zenle
const loadYceScript = () => {
  return new Promise((resolve, reject) => {
    if (window.YCE) return resolve(window.YCE);
    const s = document.createElement('script');
    s.src = 'https://plugins-media.perfectcorp.com/smb/sdk.js?apiKey=YOUR_API_KEY';
    s.onload = () => resolve(window.YCE);
    s.onerror = reject;
    document.body.appendChild(s);
  });
};
B. YCE.init() ancak SDK yÃ¼klendikten sonra ve ref.current hazÄ±rsa:
tsx
Kopyala
DÃ¼zenle
useEffect(() => {
  if (!showFacePage) return;
  loadYceScript().then(YCE => {
    if (ref.current && YCE) {
      YCE.init({ mode: 'ui', container: ref.current, ... });
    }
  });
}, [showFacePage]);
C. Chat Widget Ä°Ã§i Scroll, Overflow, Height:
EÄŸer chat modal widgetâ€™Ä± iÃ§inde aÃ§Ä±lÄ±yorsa, overflow: hidden, max-height: 0 gibi sÄ±nÄ±rlayÄ±cÄ± CSS varsa YCE UI gÃ¶rÃ¼nmez olabilir.

FaceAnalysisCamera modalâ€™i position: fixed kullanÄ±yorsa z-index deÄŸerini z-index: 1000 ve Ã¼stÃ¼ yap.

âœ… SONUÃ‡
Sorun	Ã‡Ã¶zÃ¼m
ERR_HTTP_HEADERS_SENT	res.headersSent kontrolÃ¼ ekle. Her route'da sadece 1 tane res.send/res.json kullan.
Modal gÃ¶rÃ¼nmÃ¼yor	Ref render sÄ±rasÄ±, React Portal DOM hedefi ve CSS gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et.
SDK UI gelmiyor	Script yÃ¼klenme sÄ±rasÄ±nÄ± onload ile kontrol et, ref.current null olmamalÄ±.
Chat widget iÃ§i gÃ¶rÃ¼nmÃ¼yor	CSS scroll, overflow, z-index, iframe sÄ±nÄ±rlarÄ±nÄ± kontrol et.
SPA init sorunu	SDK'yÄ± bir kere baÅŸlat, unmount edildiÄŸinde destroy et ya da yeniden mountâ€™a izin ver.